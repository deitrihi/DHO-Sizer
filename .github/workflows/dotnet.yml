# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: .NET

on:
  push:
    branches: [ "main" ]
env:
  # Path to the solution file relative to the root of the project.
  SOLUTION_FILE_PATH: .

  # Configuration type to build.
  # You can convert this to a build matrix if you need coverage of multiple configuration types.
  # https://docs.github.com/actions/learn-github-actions/managing-complex-workflows#using-a-build-matrix
  BUILD_CONFIGURATION: Release
  
jobs:
  build:

    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1
    
    - name: Restore NuGet packages
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: nuget restore ${{env.SOLUTION_FILE_PATH}}

    - name: Merge commit message
      run: |
        git log -1 --pretty=%B > message.txt
        echo "::set-output name=message::$(Get-Content message.txt)"
      id: merge_message
      # 최신 커밋 메시지를 추출하고 output 변수에 저장합니다.

    - name: Build
      if: startsWith(steps.merge_message.outputs.message, 'Release')
      working-directory: ${{env.GITHUB_WORKSPACE}}
      # Add additional options to the MSBuild command line here (like platform or verbosity level).
      # See https://docs.microsoft.com/visualstudio/msbuild/msbuild-command-line-reference
      run: msbuild /m /p:Configuration=${{env.BUILD_CONFIGURATION}} ${{env.SOLUTION_FILE_PATH}}

    - name: Collect artifacts
      shell: pwsh
      run: |
          New-Item -Type Directory dist -Force | Out-Null
          Copy-Item "DHOSizer/bin/Release/**" dist -Recurse -Force
          Copy-Item "../confing.txt" dist -Recurse -Force

    - name: Zip dist folder (Windows)
      shell: pwsh
      run: |
        Compress-Archive -Path dist\* -DestinationPath dist/DHO-Sizer.zip -Force
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
          name: DHO-Sizer
          path: dist/DHO-Sizer.zip
          retention-days: 7

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
          tag_name: v0.0.2
          files: |
            dist/DHO-Sizer.zip
